pipeline {
    agent any
    tools {
        nodejs 'Node18'
    }
    environment {
        WEB_IP = '3.89.108.191'
        SSH_CRED = 'deploy-ec2-key'
    }
    stages {
        stage('Checkout') {
            steps { checkout scm }
        }
        stage('Install dependencies') {
            steps { sh 'npm ci || npm install' }
        }
        stage('Build React App') {
            steps { sh 'npm run build' }
        }
        stage('Package Build') {
            steps {
                sh 'tar -czf build.tar.gz -C build .'
                archiveArtifacts artifacts: 'build.tar.gz'
            }
        }
        stage('Deploy to EC2') {
            steps {
                sshagent(credentials: [env.SSH_CRED]) {
                    sh '''
                    scp -o StrictHostKeyChecking=no build.tar.gz ubuntu@${3.89.108.191}:/tmp/build.tar.gz
                    ssh -o StrictHostKeyChecking=no ubuntu@${3.89.108.191} '
                      sudo rm -rf /var/www/reactapp/*;
                      sudo tar -xzf /tmp/build.tar.gz -C /var/www/reactapp;
                      sudo systemctl reload nginx
                    '
                    '''
                }
            }
        }
    }
}
